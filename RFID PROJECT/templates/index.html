<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RFID Canteen System</title>

    <!-- Barcode / QR Scanner library -->
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 420px;
            margin: auto;
        }
        input, button {
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
        }
        #transactions {
            margin-top: 20px;
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }
        #scanner {
            width: 100%;
            height: 300px;
            margin-top: 10px;
        }
        h2, h3 {
            text-align: center;
        }
    </style>
</head>
<body>
    <h2>RFID Canteen System</h2>

    <!-- RFID Section -->
    <label>RFID UID:</label>
    <input type="text" id="uid" placeholder="Enter RFID UID">
    <button onclick="scanRFID()">Check Balance</button>

    <p>Name: <span id="nameDisplay">-</span></p>
    <p id="balance">Balance: ₱0</p>

    <!-- Barcode Scanner Section -->
    <h3>Scan Food Barcode:</h3>
    <div id="scanner"></div>
    <input type="text" id="barcode" placeholder="Or enter barcode manually">
    <button onclick="purchase()">Purchase</button>

    <!-- Transaction List -->
    <div id="transactions">
        <h3>Items Purchased:</h3>
        <ul id="itemList"></ul>
    </div>

<script>
let currentUID = null;

// --- RFID BALANCE CHECK ---
function scanRFID() {
    const uid = document.getElementById("uid").value.trim();
    if (!uid) {
        alert("Please enter an RFID UID first.");
        return;
    }

    fetch("/scan_rfid", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({uid})
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "success") {
            currentUID = uid;
            document.getElementById("balance").innerText = "Balance: ₱" + data.balance;
            document.getElementById("nameDisplay").innerText = data.name;
            document.getElementById("itemList").innerHTML = "";
        } else {
            alert(data.message);
        }
    })
    .catch(err => console.error("RFID Scan Error:", err));
}

// --- PURCHASE FUNCTION ---
function purchase() {
    if (!currentUID) {
        alert("Please scan an RFID card first!");
        return;
    }

    const barcode = document.getElementById("barcode").value.trim();
    if (!barcode) {
        alert("No barcode detected or entered.");
        return;
    }

    fetch("/purchase", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({uid: currentUID, barcode})
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "success") {
            document.getElementById("balance").innerText = "Balance: ₱" + data.new_balance;
            document.getElementById("nameDisplay").innerText = data.name;

            const itemList = document.getElementById("itemList");
            itemList.innerHTML = "";
            data.transactions.forEach(t => {
                const li = document.createElement("li");
                li.innerText = `${t.item} - ₱${t.price}`;
                itemList.appendChild(li);
            });
        } else {
            alert(data.message);
        }

        document.getElementById("barcode").value = ""; // clear barcode field
    })
    .catch(err => console.error("Purchase Error:", err));
}

// --- BARCODE SCANNER ---
window.onload = function() {
    const scannerConfig = {
        fps: 10,
        qrbox: { width: 250, height: 250 }
    };

    const html5QrcodeScanner = new Html5QrcodeScanner("scanner", scannerConfig, false);

    html5QrcodeScanner.render(
        qrCodeMessage => {
            document.getElementById("barcode").value = qrCodeMessage;
            purchase(); // Auto-purchase when scanned
        },
        errorMessage => {
            console.warn("Scanning error:", errorMessage);
        }
    );
};
</script>
</body>
</html>


